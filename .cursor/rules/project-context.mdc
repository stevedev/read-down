---
description: "ReadDown: Native macOS markdown reader app — project overview, architecture, and development context."
alwaysApply: true
---

# ReadDown - Project Context

## 1. Core Purpose

ReadDown is a native macOS markdown reader application. It renders `.md` files with full GFM support (tables, task lists, fenced code), mermaid diagrams, and 8 IDE-inspired color themes. Documents open in tabs, local `.md` links can be followed within a tab (with back/forward navigation), and files auto-reload on disk changes.

## 2. Architecture

**Type:** Native macOS document-based app (SwiftUI + WKWebView)

**Rendering pipeline:**

```mermaid
graph LR
    FileDoc[MarkdownDocument: FileDocument] -->|raw text| ContentView
    ContentView -->|markdown string| WebView[MarkdownWebView: WKWebView]
    WebView -->|loads| Template[template.html]
    Template -->|marked.js| HTML[Rendered HTML]
    Template -->|mermaid.js| SVG[Mermaid SVGs]
    ThemeCSS[Active theme CSS] -->|injected| Template
```

Key architectural decisions:

- **WKWebView over native SwiftUI rendering** — SwiftUI markdown doesn't support tables or mermaid. WKWebView + JS gives full GFM + extensible rendering.
- **DocumentGroup** — SwiftUI's `DocumentGroup(viewing:)` provides native macOS tab support and automatic `open` command integration via UTI registration in Info.plist.
- **CSS-based themes** — Each theme is a standalone CSS file using CSS custom properties. Adding a theme = one CSS file + one `Theme` enum case.
- **JS bundled locally** — `marked.min.js` and `mermaid.min.js` are downloaded during setup and bundled in the app for offline use.
- **DispatchSource file watching** — Kernel-level file system monitoring per-tab, triggers re-render on write/rename/delete events.

## 3. Technology Stack

| Layer | Technology |
|-------|-----------|
| Language | Swift 5.9 |
| UI Framework | SwiftUI (macOS 14.0+) |
| Rendering | WKWebView + WebKit |
| Markdown parsing | marked.js v15.0.6 (GFM mode) |
| Diagrams | mermaid.js v11.4.1 |
| Theming | CSS custom properties |
| Build system | XcodeGen → Xcode project → xcodebuild |
| File watching | DispatchSource (GCD) |

## 4. Project Structure

```
read-down/
├── project.yml                          # XcodeGen spec → generates .xcodeproj
├── Makefile                             # setup, generate, build, install, clean
├── README.md
├── Scripts/
│   └── setup.sh                         # Downloads JS deps, installs XcodeGen, generates project
├── ReadDown/                            # Main app target
│   ├── App/
│   │   ├── ReadDownApp.swift            # @main entry, DocumentGroup(viewing:)
│   │   └── AppCommands.swift            # Theme menu, back/forward commands, Notification.Name extensions
│   ├── Models/
│   │   ├── MarkdownDocument.swift       # FileDocument conformance, UTType.markdown extension
│   │   ├── NavigationHistory.swift      # @Observable back/forward stack per tab
│   │   └── Theme.swift                  # Theme enum (8 cases), display names, CSS file mapping
│   ├── Views/
│   │   ├── ContentView.swift            # Toolbar (back/fwd/theme picker) + MarkdownWebView
│   │   └── MarkdownWebView.swift        # NSViewRepresentable WKWebView, Coordinator handles navigation delegate + JS bridge
│   ├── Services/
│   │   ├── ThemeManager.swift           # @Observable singleton, persists to UserDefaults
│   │   └── FileWatcher.swift            # DispatchSource wrapper for file system monitoring
│   ├── Resources/
│   │   ├── template.html                # HTML shell: loads theme CSS, marked.js, mermaid.js; exposes renderMarkdown/applyThemeCSS/getRawMarkdown JS API
│   │   ├── js/
│   │   │   ├── marked.min.js            # Downloaded during setup (not committed)
│   │   │   └── mermaid.min.js           # Downloaded during setup (not committed)
│   │   └── themes/
│   │       ├── github-light.css         # Light
│   │       ├── github-dark.css          # Dark
│   │       ├── dracula.css              # Dark (purple accent)
│   │       ├── one-dark.css             # Dark (Atom-style)
│   │       ├── nord.css                 # Dark (arctic blue)
│   │       ├── solarized-light.css      # Light (warm)
│   │       ├── solarized-dark.css       # Dark (warm)
│   │       └── monokai.css              # Dark (classic)
│   ├── Info.plist                       # UTI registration for .md/.markdown/.mdown/.mkd
│   └── ReadDown.entitlements            # Sandbox disabled, file read access
├── CLI/
│   └── main.swift                       # CLI tool: resolves path, calls `open -a ReadDown`
├── build/                               # xcodebuild output (gitignored)
└── ReadDown.xcodeproj/                  # Generated by XcodeGen (gitignored)
```

## 5. Key Files & Responsibilities

### ReadDownApp.swift
Entry point. Uses `DocumentGroup(viewing: MarkdownDocument.self)` which gives native tab support. Each opened file gets its own `ContentView` instance.

### MarkdownDocument.swift
`FileDocument` conformance. Declares `UTType.markdown` (imported as `net.daringfireball.markdown`). Reads/writes UTF-8 `.md` files. `readableContentTypes` includes both `.markdown` and `.plainText`.

### ContentView.swift
Per-document view. Owns:
- `@State NavigationHistory` — per-tab back/forward stack
- `@State FileWatcher` — per-tab file monitoring
- `@State currentMarkdown` / `currentFileURL` — tracks current content (may differ from original doc when navigating linked files)

Toolbar contains back/forward buttons, filename label, theme picker dropdown.

### MarkdownWebView.swift
`NSViewRepresentable` wrapping `WKWebView`. The `Coordinator` (inner class) is both `WKNavigationDelegate` and `WKScriptMessageHandler`:
- Intercepts link clicks: local `.md` files → `onNavigateToFile` callback; `http(s)` → opens in default browser
- On initial load: injects `template.html` with marked.js and mermaid.js inlined (replaces placeholder strings)
- On update: calls `window.renderMarkdown()` and `window.applyThemeCSS()` via `evaluateJavaScript`

### template.html
HTML shell loaded into WKWebView. Exposes JS API:
- `window.renderMarkdown(mdText, isDark)` — parses MD via marked.js, post-processes mermaid blocks
- `window.applyThemeCSS(css)` — injects theme CSS into `<style id="theme-style">`
- `window.setRawMarkdown(md)` / `window.getRawMarkdown()` — stores raw MD for copy-as-markdown
- `window.getSelectedText()` — returns selected text as plain string

### ThemeManager.swift
`@Observable` singleton. Persists selected theme to `UserDefaults` under key `"selectedTheme"`. Loads CSS content from bundle via `Bundle.main.url(forResource:withExtension:subdirectory:)`.

### NavigationHistory.swift
`@Observable` class. Maintains a `stack: [URL]` and `currentIndex`. Provides `push(_:)`, `goBack()`, `goForward()`. Truncates forward history on new push.

### FileWatcher.swift
Wraps `DispatchSource.makeFileSystemObjectSource`. Monitors `.write`, `.rename`, `.delete` events. Calls `onChange` closure on main queue. `watch(url:)` replaces previous watch; `stop()` cancels.

### Theme.swift
`enum Theme: String, CaseIterable, Identifiable`. 8 cases. Properties: `displayName`, `cssFileName` (matches CSS filename without extension), `isDark` (used for mermaid theme selection).

### AppCommands.swift
Adds `Theme` menu to menu bar with keyboard shortcuts (Ctrl+Cmd+1-8). Adds Back/Forward to toolbar menu. Defines `Notification.Name.navigateBack` and `.navigateForward`.

## 6. Build & Development Commands

```bash
make setup          # Install XcodeGen, download marked.js + mermaid.js, generate .xcodeproj
make generate       # Regenerate .xcodeproj from project.yml (after changing structure)
make build          # xcodebuild Release build → build/Build/Products/Release/
make build-cli      # Build CLI tool only
make install        # Copy ReadDown.app to /Applications
make install-cli    # Copy readdown binary to /usr/local/bin
make install-all    # Both of the above
make clean          # Remove build/ and .xcodeproj
```

To develop in Xcode: `open ReadDown.xcodeproj` (after `make setup` or `make generate`).

## 7. Resource Bundling

Resources are configured in `project.yml` as three separate entries:
- `ReadDown/Resources/template.html` — as individual file resource
- `ReadDown/Resources/js` — as folder reference
- `ReadDown/Resources/themes` — as folder reference

This results in `Contents/Resources/template.html`, `Contents/Resources/js/`, and `Contents/Resources/themes/` in the app bundle. The Swift code uses `Bundle.main.url(forResource:withExtension:subdirectory:)` with `subdirectory: "js"` and `subdirectory: "themes"` respectively.

## 8. How to Add a New Theme

1. Create `ReadDown/Resources/themes/{theme-name}.css` using CSS custom properties (copy an existing theme as template). Required properties: `--bg-color`, `--text-color`, `--heading-color`, `--link-color`, `--code-bg`, `--border-color`, `--blockquote-color`, `--table-alt-bg`, `--table-header-bg`.
2. Add a case to `Theme` enum in `ReadDown/Models/Theme.swift` with `rawValue` matching the CSS filename (without extension).
3. Fill in `displayName`, `isDark`, and optionally a keyboard shortcut in `AppCommands.swift`.
4. Rebuild.

## 9. How to Extend Rendering

The rendering pipeline is JS-based inside `template.html`. To add support for a new markdown extension:
1. Add the JS library to `ReadDown/Resources/js/` (and download in `Scripts/setup.sh`)
2. Add a `<script>` placeholder in `template.html` (pattern: `LIB_JS_PLACEHOLDER`)
3. Inline it in `MarkdownWebView.loadTemplate()` (same pattern as marked/mermaid)
4. Hook into the rendering pipeline in the `<script>` block of `template.html`

## 10. Known Limitations & Future Work

- **Copy-as-markdown context menu**: The JS bridge (`getRawMarkdown`, `getSelectedText`) is wired but the native `NSMenu` override for the WKWebView context menu is not yet fully implemented. The default WKWebView right-click menu works for rich text copy.
- **No syntax highlighting**: Code blocks render as plain monospace text. Could add highlight.js.
- **No print support**: Could add `window.print()` integration.
- **No search**: Could add Cmd+F find-in-document.
- **No file tree sidebar**: Could add a sidebar showing sibling/linked `.md` files.
- **No edit mode**: Currently read-only. Could add a split-pane editor.
- **Theme follows system**: Could auto-switch light/dark theme based on macOS appearance.
