<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style id="theme-style"></style>
<style>
    * { box-sizing: border-box; }
    html, body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        font-size: 15px;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
    }
    .markdown-body {
        max-width: 880px;
        margin: 0 auto;
        padding: 32px 24px;
        word-wrap: break-word;
    }
    .markdown-body table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
    }
    .markdown-body th, .markdown-body td {
        border: 1px solid var(--border-color, #ddd);
        padding: 8px 12px;
        text-align: left;
    }
    .markdown-body th {
        font-weight: 600;
    }
    .markdown-body img {
        max-width: 100%;
        height: auto;
    }
    .markdown-body pre {
        overflow-x: auto;
        padding: 16px;
        border-radius: 6px;
    }
    .markdown-body code {
        font-family: "SF Mono", SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 0.9em;
    }
    .markdown-body pre code {
        font-size: 0.85em;
    }
    .markdown-body blockquote {
        margin: 16px 0;
        padding: 0 16px;
        border-left: 4px solid var(--border-color, #ddd);
        opacity: 0.85;
    }
    .markdown-body a {
        text-decoration: none;
    }
    .markdown-body a:hover {
        text-decoration: underline;
    }
    .markdown-body hr {
        border: none;
        border-top: 1px solid var(--border-color, #ddd);
        margin: 24px 0;
    }
    .mermaid {
        text-align: center;
        margin: 16px 0;
    }
</style>
<script>MARKED_JS_PLACEHOLDER</script>
<script>MERMAID_JS_PLACEHOLDER</script>
<script>HLJS_JS_PLACEHOLDER</script>
</head>
<body>
<div id="content" class="markdown-body"></div>
<script>
(function() {
    const renderer = new marked.Renderer();

    // Intercept code blocks for mermaid
    const originalCode = renderer.code;
    renderer.code = function({ text, lang }) {
        if (lang === "mermaid") {
            return '<div class="mermaid">' + text + '</div>';
        }
        const escaped = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const langClass = lang ? ' class="language-' + lang + '"' : '';
        return '<pre><code' + langClass + '>' + escaped + '</code></pre>';
    };

    marked.setOptions({
        renderer: renderer,
        gfm: true,
        breaks: false
    });

    let mermaidInitialized = false;

    function initMermaid(isDark) {
        const theme = isDark ? "dark" : "default";
        mermaid.initialize({
            startOnLoad: false,
            theme: theme,
            securityLevel: "loose"
        });
        mermaidInitialized = true;
    }

    async function renderMermaidBlocks() {
        const blocks = document.querySelectorAll(".mermaid");
        for (let i = 0; i < blocks.length; i++) {
            const block = blocks[i];
            const code = block.textContent;
            try {
                const { svg } = await mermaid.render("mermaid-" + i, code);
                block.innerHTML = svg;
            } catch (e) {
                block.innerHTML = '<pre style="color:red;">Mermaid error: ' + e.message + '</pre>';
            }
        }
    }

    function rewriteRelativeImages() {
        var base = document.querySelector('base');
        if (!base || !base.href) return;
        var baseHref = base.href;
        document.querySelectorAll('#content img').forEach(function(img) {
            var src = img.getAttribute('src');
            if (src && !src.startsWith('http') && !src.startsWith('data:') && !src.startsWith('file:')) {
                img.src = baseHref + src;
            }
        });
    }

    function extractHeadings() {
        var headings = [];
        document.querySelectorAll('#content h1, #content h2, #content h3, #content h4, #content h5, #content h6').forEach(function(h, i) {
            if (!h.id) h.id = 'heading-' + i;
            headings.push({ id: h.id, level: parseInt(h.tagName[1]), text: h.textContent });
        });
        try {
            window.webkit.messageHandlers.headingsExtracted.postMessage(JSON.stringify(headings));
        } catch(e) {}
    }

    window.renderMarkdown = async function(mdText, isDark, scrollY) {
        if (!mermaidInitialized || isDark !== window._lastIsDark) {
            initMermaid(isDark);
            window._lastIsDark = isDark;
        }
        var html = marked.parse(mdText);
        document.getElementById("content").innerHTML = html;
        await renderMermaidBlocks();
        hljs.highlightAll();
        rewriteRelativeImages();
        extractHeadings();
        window.scrollTo(0, (scrollY !== undefined && scrollY !== null) ? scrollY : 0);
    };

    window.scrollToHeading = function(id) {
        var el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    window.findText = function(query, forward) {
        if (!query) {
            window.getSelection().removeAllRanges();
            return false;
        }
        return window.find(query, false, !forward, true);
    };

    window.applyThemeCSS = function(css) {
        document.getElementById("theme-style").textContent = css;
    };

    // For copy-as-markdown: store raw markdown
    window._rawMarkdown = "";
    window.setRawMarkdown = function(md) {
        window._rawMarkdown = md;
    };
    window.getRawMarkdown = function() {
        return window._rawMarkdown;
    };

    // Get selected text as plain text (for markdown copy)
    window.getSelectedText = function() {
        return window.getSelection().toString();
    };

    // Get selected range info for mapping back to markdown source
    window.getSelectionInfo = function() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return null;
        return {
            text: sel.toString(),
            hasSelection: sel.toString().length > 0
        };
    };

    window.setBaseURL = function(url) {
        var base = document.querySelector('base');
        if (!base) {
            base = document.createElement('base');
            document.head.prepend(base);
        }
        base.href = url;
    };

    document.addEventListener('click', function(e) {
        var target = e.target;
        while (target && target.tagName !== 'A') target = target.parentElement;
        if (!target) return;
        var href = target.getAttribute('href');
        if (!href || href.startsWith('#')) return;
        e.preventDefault();
        window.webkit.messageHandlers.linkClicked.postMessage({
            href: href,
            scrollY: window.scrollY
        });
    });

    var _scrollTimer;
    document.addEventListener('scroll', function() {
        clearTimeout(_scrollTimer);
        _scrollTimer = setTimeout(function() {
            try {
                window.webkit.messageHandlers.scrollPosition.postMessage(window.scrollY);
            } catch(e) {}
        }, 100);
    });
})();
</script>
</body>
</html>
